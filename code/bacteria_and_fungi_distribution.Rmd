---
title: "Bacteria and fungi distribution model"
author: "Mathis Gheno"
date: "2024-10-17"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
## ---- IMPORT PACKAGES ----
library(readxl)
library(tidyverse)
library(iNEXT)
library(GGally)
library(sbm)
library(FactoMineR)
library(vegan)
library(alluvial) #aluvial plot
library(MuMIn) # model selection
library(aricode) # NMI
library(purrr)


library(factoextra)
library(corrplot)
library(RColorBrewer)
```


```{r}
## ---- usefull function ----
main_theme = theme_minimal()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=22, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=22, face="italic"),
        legend.title = element_text(colour = "black", size=20,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=28),
        strip.text = element_text(colour = "black", size=15, face ="italic"))

zscore_normalization <- function(data) {
  # Step 1: Rank the data
  ranked_data <- rank(data)
  n <- length(data)
  
  # Step 2: Calculate quantile positions
  quantile_positions <- (ranked_data) / (n + 1)
  
  # Step 3: Transform quantiles to z-scores
  mean_std_normal <- qnorm(quantile_positions)
  
  return(mean_std_normal)
}
  
  
replace_unknown_taxonomy <- function(taxonomy_vector) {
 taxonomy_vector %>%
    str_split(pattern = "\\|") %>%
    map_chr(function(x) {
      # Iterate over the taxonomy ranks and replace "unknown"
      for (i in length(x):1) {
        if (str_detect(x[i], "unknown")) {
          # Find the nearest known taxonomic rank
          known_rank <- x[max(which(!str_detect(x, "unknown")))]
          known_name <- str_extract(known_rank, "[^__]+$")
          known_initial <- substr(known_rank, 1, 1)
          
          # Replace "unknown" with "unknown_<known_rank>_<initial>"
          x[i] <-  paste0("unknown__", known_name, "_", known_initial)
        }
      }
      # Join the ranks back into a single string
      str_c(x, collapse = "|")
    })
}

bact_taxonomic_levels <- c("kingdom", "phylum", "class", "order", "family", 
                           "genus", "species")

# import data
.%>%
  read_tsv() %>%
  #{{format column names}}
  rename_with(~sub("\\_.*", "", .)) %>%
  rename_with(~gsub("-", "_", .)) %>%
  rename_with(~gsub("OR", "BU",.)) %>%
  rename(CONT_BU_ext = BU_T_extr) %>%
  rename(CONT_BU_PCR1 = T_1) %>%
  rename(CONT_BU_PCR2 = T_2) %>% 
  #{{select samples from ORACLE project}}
  select(OTU, taxonomy, starts_with("CONT", ignore.case = FALSE), 
         starts_with("BU", ignore.case = FALSE)) %>%
  #{{keep only resequenced samples when available}}
  select(-BU_SER_10, -BU_ST_10, -BU_YL_19, -BU_TS_3) %>%
  #{{homogeneize resequenced sample names}}
  rename(BU_SER_10 = BU_SER_10_S) %>%
  rename(BU_ST_10 = BU_ST_10_S) %>%
  rename(BU_YL_19 = BU_YL_19_S) %>%
  rename(BU_TS_3 = BU_TS_3_S) %>%
  rename_with(~sub("\\_1$", "_01", .)) %>%
  rename_with(~sub("\\_2$", "_02", .)) %>%
  rename_with(~sub("\\_3$", "_03", .)) %>%
  rename_with(~sub("\\_4$", "_04", .)) %>%
  rename_with(~sub("\\_5$", "_05", .)) %>%
  rename_with(~sub("\\_6$", "_06", .)) %>%
  rename_with(~sub("\\_7$", "_07", .)) %>%
  rename_with(~sub("\\_8$", "_08", .)) %>%
  rename_with(~sub("\\_9$", "_09", .)) %>%
  #{{sequences with "No_hit" has to be deleted}}
  filter(grepl("Bacteria|Archaea",taxonomy)) %>%
  mutate(taxonomy = str_replace_all(taxonomy, "uncultured|\\*|Incertae_Sedis", "unknown"),
         taxonomy = replace_unknown_taxonomy(taxonomy)
         ) %>%
  separate(taxonomy, bact_taxonomic_levels, sep = "[|]", extra = "drop") %>%
  #{{sequences affiliated to chloroplast and mitonchondria are excluded}}
  filter(order != "Chloroplast", family != "Mitochondria")%>%
  droplevels() -> rename.cols.and.arrange.taxonomy




. %>%
  replace(. == 0, NA) %>%
  pivot_longer(starts_with("BU"), names_to = "samples", values_to = "reads") %>%
  filter(!is.na(reads)) %>%
  # merge control samples
  mutate( n = rowSums(across(starts_with("CONT")), na.rm = T)
          ) %>%
  # substract abundance of control samples
  mutate(reads = case_when(
    is.na(n)  ~ reads,
    n > reads ~ 0,
    TRUE      ~ reads - n)
    ) %>%
  select(-n,-starts_with("CONT")) %>%
  pivot_wider(values_from = reads, names_from = samples, values_fill = 0) -> decontaminate
```

```{r}
bact_data_path<- "data/Oracle_soils_16S_341F_785R_87_samples.OTU.filtered.cleaved.nosubstringOTUs.mumu.table2"

bact_data_path %>%
  rename.cols.and.arrange.taxonomy %>%
  decontaminate -> bact_ASV

bact_tax <- bact_ASV %>%
  select(OTU, all_of(bact_taxonomic_levels))
```


```{r}
## ---- IMPORT DATA ----

read_tsv("data/metadata.txt") %>%
  rename_with(~gsub(".", "_", ., fixed = TRUE)) -> metadata

read_tsv("data/sample_coordinates.tsv") %>%
  rename(soil_code = "samples") %>%
  mutate(soil_code = str_replace(soil_code,"([A-Z]+)(\\d+)","BU_\\1_\\2")) -> coord

read_tsv("data/divesities_bact.tsv") %>%
  dplyr::select(starts_with("Hill_"),soil_code) -> div_bact

read_xlsx("data/Historique_Parcelles-Oracle.xlsx") %>%
  dplyr::select(`N° Parcelle`, ...14, ...17,...20,) %>%
  rename(soil_code = "N° Parcelle", cultu_2014 = "...14", cultu_2015 = "...17",cultu_2016 = "...20") %>%
  mutate(soil_code = paste0("BU_",str_replace(soil_code, "([A-Z]+)(\\d+)", "\\1_\\2"))) -> preced_cultu

read_xlsx("data/Soil_Parameters_oracle.xlsx") %>%
  dplyr::select(`Var niébé 2017`, `Var Sorgho 2017`) %>%
  rename(varnieb = "Var niébé 2017", varsorgh = "Var Sorgho 2017") -> variety

metadata %>%
  dplyr::select(pracul,modsem,FO_Qte ,denpoq, freqsar, NPK_qte, uree_qte) %>%
  mutate(pracul = as.factor(pracul),
                 modsem = as.factor(modsem)) -> agri_practice

agri_practice %>%  
  mutate(across(where(is.numeric),~decostand(.x,"standardize")[,1])) -> agri_practice_standa

read_xlsx("data/Soil_Parameters_oracle.xlsx") %>%
  dplyr::select(`C (g kg-1)`,`C/N`, `CEC (cmolc/kg)`, `Ca (cmol/kg)`,`Mg (cmolc/kg)`, `K(cmolc/kg)`, `SBE (cmolc/kg)`,           
    `TS (%)`, Site...3, `N° site...4`) %>%
  rename(Site = "Site...3",N_site = "N° site...4", C = "C (g kg-1)",CN = "C/N", CEC = "CEC (cmolc/kg)", Ca = "Ca (cmol/kg)",Mg = "Mg (cmolc/kg)",K = "K(cmolc/kg)",SBE = "SBE (cmolc/kg)",           
         ,TS = "TS (%)" ) %>%
  mutate( N_site = str_replace(as.character(N_site), "^[1-9]$", "0\\0"),
          soil_code = str_c(Site,N_site)) %>%
  mutate(soil_code = str_c("BU_",Site,"_",N_site)) %>%
  left_join(metadata%>%dplyr::select(pHeau,Pto,Kto,Nto,MO,soil_code), by = "soil_code") -> soil

```

# Clustering covariate

## Cultural History

```{r echo = T, results = 'hide'}
preced_cultu%>%
  filter(!(is.na(cultu_2014) | is.na(cultu_2015) | is.na(cultu_2016))) -> preced_cultu
preced_cultu%>%
  mutate(across(starts_with("cultu"), ~case_when(
    .x == "Ass_Ses+N" ~ "c+l", # c : cereal ; l = legumes
    .x == "Ass_M+N" ~ "c+l",
    .x == "Ass_S+N" ~ "c+l",
    .x == "Ass_S+M+N" ~ "c+l",
    .x == "Rot_Avec_Leg" ~ "l",
    .x == "Rot_Sans_Leg" ~ "c",
    .x == "Jachère" ~ "jachere"
  ))) -> preced_cultu_cere_legu

### disjonctif table usable by sbm
tab.disjonctif(preced_cultu_cere_legu$cultu_2014) -> cult2014_bis
tab.disjonctif(preced_cultu_cere_legu$cultu_2015) -> cult2015_bis
tab.disjonctif(preced_cultu_cere_legu$cultu_2016) -> cult2016_bis

### check if colnames concord with eachother
colnames(cult2014_bis)
colnames(cult2015_bis)
colnames(cult2016_bis)

cult2014_bis = cbind(cult2014_bis,jachere = 0)

cult2014_bis%>%
  t()%>%
  plotMyMatrix(dimLabels = c("cult2014", "soil_code"), plotOptions = list(rowNames = T,colNames = F))
cult2015_bis%>%
  t()%>%
  plotMyMatrix(dimLabels = c("cult2014", "soil_code"), plotOptions = list(rowNames = T,colNames = F))
cult2016_bis%>%
  t()%>%
  plotMyMatrix(dimLabels = c("cult2014", "soil_code"), plotOptions = list(rowNames = T,colNames = F))

### create networks objects
net2014_bis <- defineSBM(cult2014_bis, model = "bernoulli", dimLabels = c(col = "soil_code", row = "cult_cult_history"))# row and col inverted, bug ? 
net2015_bis <- defineSBM(cult2015_bis, model = "bernoulli", dimLabels = c(col = "soil_code", row = "cult_cult_history"))
net2016_bis <- defineSBM(cult2016_bis, model = "bernoulli", dimLabels = c(col = "soil_code", row = "cult_cult_history"))

### compute smb
set.seed(2)
estimateMultiplexSBM(list(net2014_bis, net2015_bis, net2016_bis), dependent = FALSE) -> sbm_preced_cult_bis
plot(sbm_preced_cult_bis)
```


## Soil

```{r echo = T}
soil%>%
  select(-c(soil_code, N_site, Site))%>%
  mutate_all(~zscore_normalization(.))%>%
  as.matrix()-> soil_standard_rank

set.seed(2)
smb_soil <- estimateBipartiteSBM(soil_standard_rank, model = "gaussian", estimOptions = list(plot = FALSE))
```


## Variety

```{r}
variety%>%
  mutate(varnieb = case_when(varnieb == "beng-raaga" ~"Beng-raaga",
                   varnieb == "Beng-yaanga spécial" ~"Beng-yaanga",
                   varnieb == "beng-yaanga" ~"Beng-yaanga",
                   varnieb == "beng raaga(beng zaalé)" ~"Beng-raaga",
                   varnieb == "Beng raaga" ~"Beng-raaga",
                  .default = as.character(varnieb)),
         varsorgh = case_when(varsorgh == "Mélange(Pissopoé + Mitindaadé)" ~"Mélange(Pissopoé + Mitindaadé)",
                   varsorgh == "rouko" ~"Rouko",
                  .default = as.character(varsorgh))) -> variety

tab.disjonctif(variety$varnieb) -> varnieb

varnieb%>%
  as.data.frame()%>%
  mutate(`Beng-raaga` = `Beng-raaga` + `Mélange (beng-raaga+Beng-yaanga)`,
         `Beng-yaanga` = `Beng-yaanga` + `Mélange (beng-raaga+Beng-yaanga)`) %>%
  select(!(starts_with("Mélange") ))%>%
  as.matrix() -> varnieb

tab.disjonctif(variety$varsorgh) -> varsorgh

varsorgh%>%
  as.data.frame()%>%
  mutate(`ICSV-1049` = `ICSV-1049` + `Mélange (ICSV-1049+Mitindaadé)`,
         `Mitindaadé` = `Mitindaadé` + `Mélange (ICSV-1049+Mitindaadé)`,
         Rouko = Rouko + `Mélange (Mitindaadé+rouko)`,
         `Mitindaadé` = `Mitindaadé` + `Mélange (Mitindaadé+rouko)`,
         Pisnou = Pisnou + `Mélange (Pisnou+Kazinga)`,
         Kazinga = `Mélange (Pisnou+Kazinga)`,
         `Mitindaadé` = `Mitindaadé` + `Mélange (Pissopoé + Mitindaadé)`,
         `Pissopoé` = `Pissopoé` + `Mélange (Pissopoé + Mitindaadé)`,
                  `Mitindaadé` = `Mitindaadé` + `Mélange(Pissopoé + Mitindaadé)`,
         `Pissopoé` = `Pissopoé` + `Mélange(Pissopoé + Mitindaadé)`,
         `Zoé-wongo` =  `Mélange (Zoé-wongo+Kourbouli)`,
         Kourbouli =  Kourbouli + `Mélange (Zoé-wongo+Kourbouli)`,
        `Zoé-wongo` = `Zoé-wongo` + `Zoé-wongo+rouko`,
         Rouko = Rouko + `Zoé-wongo+rouko`)%>%
        select(!(starts_with("Mélange")  | "Zoé-wongo+rouko"))%>%
  as.matrix() -> varsorgh

cbind(varnieb, varsorgh)%>%
  data.frame()%>%
  mutate(across(everything(), ~case_when(. == 1 ~  cur_column(),
                                          . == 0 ~ NA)))%>%
  tidyr::unite("cult_var", na.rm = T) -> cult_var_df
  
cult_var_df%>%
  group_by(cult_var)%>%
  summarise(n= n())-> cult_var_count_df

ggplot(cult_var_count_df)+
  geom_point(aes(cult_var, n), cex = 3)+
  main_theme+
  theme(axis.text.x = element_text(colour = "black", size=12, face="italic", angle = 45, vjust = 1, hjust = 1))

```
3 cereal and legum composition are most represented. To simplify I keep those and add a 4th class containing all other composition

```{r}
cult_var_df%>%
  left_join(cult_var_count_df, by = "cult_var")%>%
  # but culture variety type in other when they appear less than 5 time in the 80 samples
  mutate(cult_var = case_when(n<5 ~ "others",
                              cult_var == "Beng.raaga_Mitindaadé_Pissopoé" ~ "Beng.raaga_Pissopoé",
                              cult_var == "Beng.raaga_Balinpèlga" ~ "others",
                               .default = cult_var),
          soil_code = soil$soil_code)%>%
  select(-n) -> cult_var_df

cult_var_df%>%
  group_by(cult_var)%>%
  summarise(n= n())%>%
  ggplot()+
  geom_point(aes(cult_var, n), cex = 3)+
  scale_y_continuous(limits = c(0,30))+
  main_theme+
  theme(axis.text.x = element_text(colour = "black", size=12, face="italic", angle = 45, vjust = 1, hjust = 1))
```

### Agricultural practice
SBM don't work with those data. don't respect distribution even with rank standardization. I'm using PCA and hierarchical clustering.
```{r}
agri_practice%>%select(where(is.numeric)) %>% # agri practice quanti
  decostand("standardize")%>%
  PCA -> PCA_practices
 PCA_practices%>%
  HCPC(-1)-> HCPC_pca_practice

fviz_pca_biplot(PCA_practices, habillage = HCPC_pca_practice$data.clust$clust, addEllipses  =T, ellipse.level = 0.95) 
```


```{r}
# cultural past
data.frame(clust_cult_history = sbm_preced_cult_bis$memberships$cult_cult_history, 
                         soil_code = preced_cultu$soil_code) -> cluster_df
cluster_df %>%
  # soil
  left_join( data.frame(clust_soil = smb_soil$memberships$row,
                       soil_code = soil$soil_code ), by = "soil_code")  %>%
  # variety
  left_join( cult_var_df, by = "soil_code") %>%
  # agricultural practice
  left_join( data.frame(clust_cult_practice = HCPC_pca_practice$data.clust$clust,
                        soil_code = metadata$soil_code ), by = "soil_code") %>%
  mutate(locality = factor((str_extract(soil_code,"((?<=^.{3})[A-Z]+)")))) -> cluster_df

cluster_df$clust_cult_history <- factor(cluster_df$clust_cult_history, labels = c( "Cereales +\n legumes only", "mixte"))

cluster_df$clust_soil <- factor(cluster_df$clust_soil, labels = c( "high cation \n concentration + \n fertile", 
                                                 "high cation \n concentration",
                                                 "mid cation/fertile",
                                                 "low cation/fertile"))
```

## Rarefaction
```{r}
rarefaction.func <- function(df,rar_sample, n_rare = 100){
   df %>%
    select(starts_with("BU")) %>%
    dim -> D
   # {{rarefaction}}
  df_rarefy = matrix(0, nrow =  D[1], ncol = D[2])
  for(n in 1:n_rare){
  df %>%
    select(starts_with("BU")) %>%
    t() %>%
    vegan::rrarefy(rar_sample) %>%
    t() + df_rarefy -> df_rarefy
    
  }
  round(df_rarefy/n_rare) -> df_rarefy
  df_rarefy %>%
    bind_cols(
      df %>%
        select(!starts_with("BU"))
    ) -> df_rarefy
  return(df_rarefy)
}
```

```{r}
set.seed(182631)
bact_ASV %>%
  select(starts_with("BU")) %>%
  colSums %>%
  min -> min_sample

bact_ASV %>%
  rarefaction.func(min_sample) -> bact_ASV_rare
```


```{r}
bact_ASV_rare %>%
  select(starts_with("BU")) %>%
  colSums

bact_ASV_rare %>%
  filter(rowSums(across(starts_with("BU"))) == 0) %>%
  select(-starts_with("BU")) -> ultra_rare_bact
table(ultra_rare_bact$class) %>%
  sort(decreasing = T)

bact_ASV_rare %>%
  filter(rank(rowSums(across(starts_with("BU")))) > 59000) %>%
  select(-starts_with("BU")) -> abund_bact
table(abund_bact$class) %>%
  sort(decreasing = T)
```

```{r}
bact_ASV_rare %>% 
  filter(rowSums(across(starts_with("BU")) != 0) > 3 & # occur more than 3 times across sample
         rowSums(across(starts_with("BU"))) > 10 # reads count > 10 across sample
         ) %>%
  column_to_rownames("OTU")-> bact_ASV_rare_filtred
```

## Diversities 
```{r}
compute.hill.diversities<- function(community_matrix){
  div_id = c(richness = 0, shanon = 1, simpson = 2)
  
  community_matrix %>%
    select(starts_with("BU")) -> community_matrix
  
  div_id %>%
    purrr::map(\(x) hilldiv::hill_div(community_matrix, qvalue = x)) %>%
    as.data.frame() %>%
    rownames_to_column("soil_code") %>%
    mutate(eveness_shanon = shanon/richness,
           eveness_simson = simpson/richness) %>%
    pivot_longer(-soil_code, names_to = "hill_diversity_type", values_to = "diversity_values")
}
```

```{r}
bact_ASV_rare_filtred %>%
  compute.hill.diversities -> diversities_df
```

### Diversities vs soil
```{r}
library(RColorBrewer)

soil %>%
  left_join(diversities_df, by = "soil_code") %>%
  mutate(K = case_when(K>3 ~ NA,
                       .default = K))%>%
  pivot_longer(-c(soil_code, hill_diversity_type, diversity_values, N_site,Site   ), names_to = "soil_name", values_to = "soil_val")-> diversities_soil_df
diversities_soil_df %>%
  filter(hill_diversity_type == "richness") %>%
  ggplot() +
  geom_point(aes(soil_val, diversity_values, col = Site)) +
  geom_smooth(aes(soil_val, diversity_values), method = "lm")+
  facet_wrap(~soil_name, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()

diversities_soil_df %>%
  filter(hill_diversity_type == "shanon") %>%
  ggplot() +
  geom_point(aes(soil_val, diversity_values, col = Site)) +
  geom_smooth(aes(soil_val, diversity_values), method = "lm")+
  facet_wrap(~soil_name, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()

diversities_soil_df %>%
  filter(hill_diversity_type == "simpson") %>%
  ggplot() +
  geom_point(aes(soil_val, diversity_values, col = Site)) +
  geom_smooth(aes(soil_val, diversity_values), method = "lm")+
  facet_wrap(~soil_name, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()
```

### Diversities vs cluster

```{r}
library(RColorBrewer)

cluster_df %>%
  left_join(diversities_df, by = "soil_code") %>%
  pivot_longer(-c(soil_code, hill_diversity_type, diversity_values,locality), names_to = "cluster_type", values_to = "cluster_val")-> diversities_clust_df

diversities_clust_df %>%
  filter(hill_diversity_type == "richness") %>%
  ggplot() +
  geom_boxplot(aes(cluster_val, diversity_values)) +
  geom_smooth(aes(cluster_val, diversity_values), method = "lm")+
  facet_wrap(~cluster_type, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()

diversities_clust_df %>%
  filter(hill_diversity_type == "shanon") %>%
  ggplot() +
  geom_boxplot(aes(cluster_val, diversity_values)) +
  geom_smooth(aes(cluster_val, diversity_values), method = "lm")+
  facet_wrap(~cluster_type, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()


diversities_clust_df %>%
  filter(hill_diversity_type == "simpson") %>%
  ggplot() +
  geom_boxplot(aes(cluster_val, diversity_values)) +
  geom_smooth(aes(cluster_val, diversity_values), method = "lm")+
  facet_wrap(~cluster_type, scale = "free") +
  scale_color_brewer(palette = "Set1")+
  theme_minimal()

```

## SVD
```{r}
library(svd)
svd.rpd <-function(trun, ntw){
  ### truncate at n dim
  SVD = propack.svd(community_matrix, neig = trun)
  trunc_d =  diag(sqrt(SVD$d))
  
  
  
  L =(SVD$u %*% trunc_d)
  egein_V = SVD$d
  
  R = trunc_d %*% t(SVD$v)
  t_R = t(R)#[,1:12]
  
  return(list(L = L,t_R = t_R, egein_V = egein_V, trun = trun))
}
trun = 2:80

community_matrix <- bact_ASV_rare_filtred %>%
  select(starts_with("BU")) %>%
  as.matrix %>% t()
SVD_min = propack.svd(community_matrix, neig = 1)
SVD_max = propack.svd(community_matrix)
eigenval_max_sum <- sum(SVD_max$d)

trun |> 
  purrr::map(\(x) svd.rpd(x,community_matrix)) -> test
transformed_list <- map(test, function(x) data.frame(trunc = x[["trun"]],  eigenval_ratio =  sum(x[["egein_V"]])/eigenval_max_sum, eigen_val = log(tail(x[["egein_V"]],1L))))%>%
  bind_rows()
transformed_list%>%
  pivot_longer(-trunc) %>%
  ggplot()+
  geom_point(aes(trunc, value))+
  facet_wrap(~name, scales = "free", nrow = 2)+
  main_theme
test[[2]]$L %*% diag(test[[2]]$egein_V) %*% t(test[[2]]$t_R)
hist(test[[50]]$L, breaks = 100)


rownames(test[[50]]$L) = rownames(community_matrix)
colnames(test[[50]]$L) = as.character(1:51)
test[[50]]$L %>% 
  plotMyMatrix(dimLabels = c("soil_code", "idk"), plotOptions = list(rowNames = T,colNames = T))+
  theme(
    legend.position="none",
    axis.text.x =element_text(angle = 45, vjust = 1, hjust = 1, size = 6, face="italic"),
    axis.text.y = element_text(size = 5,face="italic"))

hist(test[[50]]$L %*% diag(test[[50]]$egein_V))

test[[50]]$L %*% diag(test[[50]]$egein_V) %>% 
  plotMyMatrix(dimLabels = c("soil_code", "idk"), plotOptions = list(rowNames = T,colNames = T))+
  theme(
    legend.position="none",
    axis.text.x =element_text(angle = 45, vjust = 1, hjust = 1, size = 6, face="italic"),
    axis.text.y = element_text(size = 5,face="italic"))
```

```{r}
bact_ASV_rare_filtred %>%
  filter(str_detect(species, "unknown"))
```


```{r}
bact_ASV_rare_filtred %>%
  filter(str_detect(species, "unknown"))
```


```{r}
bact_ASV_rare_filtred %>%
  select(starts_with("BU")) %>%
  sample_n(1000) -> bact_ASV_rare_filtred_subsample
```


```{r}
bact_ASV_rare_filtred_subsample %>%
  select(starts_with("BU")) %>%
  as.matrix %>%
  t() %>%
  estimateBipartiteSBM(
    model = 'poisson', 
    dimLabels = c("soil_code", "Bact_Known"),
    estimOptions = list(nbCores = 1,plot = F)) -> sbm_bact_known
```


```{r}
studyDesign = data.frame(sample = colnames(bact_ASV_rare_filtred_subsample), stringsAsFactors=TRUE)
rL = HmscRandomLevel(units = studyDesign$sample)
rL$nfMax = 15

bact_ASV_rare_filtred_subsample %>%
  mutate(across(everything(), ~case_when(
    .x==0 ~NA,
    .default = .x)
    )
  ) %>%
  as.matrix -> bact_ASV_rare_filtred_subsample_na
bact_ASV_rare_filtred_subsample_na %>%
  as.matrix %>%
  log %>%
  hist(breaks = 1000) 

rL = HmscRandomLevel(units = studyDesign$sample)
rL$nfMax = 15

m1 = Hmsc(Y = bact_ASV_rare_filtred_subsample_na %>% t(), studyDesign = studyDesign,
         XData = soil%>%select(pHeau,CEC), XFormula =  ~ CEC +pHeau,
         distr = "poisson", ranLevels = list(sample = rL))

nChains = 2
test.run = T
if (test.run){

thin = 2
samples = 200
transient = 50
} else {

thin = 10
samples = 1000
transient = 500
}
verbose = 10
m_fit1 = sampleMcmc(m1, thin = thin, samples = samples, transient = transient,
nChains = nChains, nParallel = nChains, verbose = verbose)


postGamma = getPostEstimate(m_fit1, parName = "Gamma")
plotGamma(m_fit1, post=postGamma, param="Support", supportLevel = 0.95)

postBeta = getPostEstimate(m_fit1, parName="Beta")
plotBeta(m_fit1, post=postBeta, param="Support", supportLevel = 0.95)

Gradient = constructGradient(m_fit1, focalVariable = "CEC", ngrid = 80)
predY = predict(m_fit1, XData=Gradient$XDataNew, expected=TRUE)
par(mfrow = c(1,1))
plotGradient(m_fit1, Gradient, pred=predY, measure="S", showData = TRUE)
plotGradient(m_fit1, Gradient, pred=predY, measure="Y", index = 4, showData = TRUE)
```


